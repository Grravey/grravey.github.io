<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>David &amp; Suzy | RSVP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            lagoon: '#0C3A47',
            drift: '#1F5664',
            pine: '#2F6B57',
            teal: '#4C8B7A',
            mist: '#E7F4F3',
            cloud: '#F7FBFB',
            blush: '#F0E4DC',
          },
          fontFamily: {
            sans: ['Work Sans', 'Inter', 'system-ui', 'sans-serif'],
            serif: ['Playfair Display', 'Georgia', 'serif'],
          },
        },
      },
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
</head>
<body data-api-base="https://i0venlddpb.execute-api.us-west-2.amazonaws.com/prod" class="bg-cloud text-lagoon font-sans antialiased">
  <main class="mx-auto flex min-h-screen max-w-4xl flex-col gap-12 px-4 py-16 sm:px-6 sm:py-20">
    <header class="rounded-[2.5rem] border border-teal/40 bg-white/85 p-10 text-center shadow-sm backdrop-blur-sm sm:p-14">
      <div class="space-y-6">
        <span class="inline-flex items-center justify-center gap-2 rounded-full bg-teal/10 px-4 py-1 text-xs uppercase tracking-[0.4em] text-teal">RSVP</span>
        <h1 class="font-serif text-4xl font-semibold sm:text-5xl">Join us for dinner</h1>
        <p class="mx-auto max-w-2xl text-base leading-relaxed text-lagoon/80">
          Tell us who is coming, and what you want to eat.
        </p>
      </div>
    </header>

    <section class="flex-1">
      <div id="app" class="space-y-6 rounded-[2rem] border border-teal/30 bg-white/70 p-8 shadow-sm backdrop-blur-sm sm:p-10">
        <div class="space-y-3 text-center">
          <p class="font-serif text-2xl text-lagoon">Loading RSVP details‚Ä¶</p>
          <p class="text-sm text-lagoon/70">If you see this message for more than a moment, enable JavaScript in your browser.</p>
        </div>
      </div>
    </section>

    <footer class="pb-6 text-center text-xs uppercase tracking-[0.3em] text-lagoon/50">
      <span>David &amp; Suzy &middot; 2025</span>
    </footer>
  </main>

  <script>
    (() => {
      const body = document.body;
      const API_BASE_URL = (window.RSVP_API_BASE || body.dataset.apiBase || '').replace(/\/$/, '');
      const container = document.getElementById('app');
      if (!container) return;

      const MENU_OPTIONS = {
        starter: [
          { id: 'braised meatballs', label: "<b>Braised meatballs</b>, <em>pomodoro, grana padana, toasted sourdough</em>" },
          { id: 'crab cake', label: "<b>Pan-fried crab and cod cake</b>, <em>curry aioli, herb salad</em>" },
          { id: 'greens', label: "<b>Shaved vegetables</b>, <em>white balsamic vinaigrette, herb crumb</em>"}
        ],
        main: [
          { id: 'tenderloin', label: "<b>AAA Canadian beef tenderloin</b>, <em>carrots, pomme pureÃÅe, green peppercorn jus</em>" },
          { id: 'salmon', label: "<b>BC spring salmon</b>, <em>beets, quinoa, charred lemon glaze</em>" },
          { id: 'chicken', label: "<b>Fraser Valley chicken breast</b>, <em>sp√§tzle, parsnips, natural jus</em>" },
          { id: 'vegetarian', label: "<b>Seasonal harvest</b>, <em>Potato r√∂sti, seasonal vegetables, du Puy lentils</em>" }
        ],
        dessert: [
          { id: 'lime curd', label: "<b>Lime curd</b>, <em>white chocolate chantilly, graham crumb, tonka bean</em>" },
          { id: 'sticky toffee', label: "<b>Sticky toffee pudding</b>, <em>whipped cr√®me fra√Æche</em>" },
        ],
      };

      const HOST_CONTACT_HTML = `Text or call <span class="font-semibold">David</span> at <a href="tel:+15104031367" class="font-semibold text-teal hover:text-teal/80 focus:text-teal/80">(510) 403-1367</a>.`;

      const state = {
        code: '',
        status: 'idle',
        loadError: '',
        names: [],
        people: {},
        submitStatus: 'idle',
        submitMessage: '',
        formError: '',
        summary: null,
      };

      const submittingOverlay = document.createElement('div');
      submittingOverlay.id = 'rsvp-submitting-overlay';
      submittingOverlay.className = 'fixed inset-0 z-[60] hidden items-center justify-center bg-cloud/80 backdrop-blur-sm';
      submittingOverlay.innerHTML = `
        <div class="flex flex-col items-center gap-5 rounded-[2rem] border border-teal/50 bg-white/90 px-10 py-8 text-center shadow-lg">
          <span class="relative inline-flex h-20 w-20 items-center justify-center">
            <span class="absolute inset-0 animate-ping rounded-full bg-teal/40"></span>
            <span class="relative inline-flex h-16 w-16 items-center justify-center rounded-full border-4 border-teal/30 bg-mist/90 text-3xl font-serif text-teal">‚ú®</span>
          </span>
          <div class="space-y-2">
            <p class="font-serif text-2xl text-lagoon">Sending your RSVP‚Ä¶</p>
            <p class="text-sm text-lagoon/70">We‚Äôre sharing your answers with David &amp; Suzy. One moment!</p>
          </div>
        </div>
      `;
      body.appendChild(submittingOverlay);

      const toggleSubmittingOverlay = (visible) => {
        if (visible) {
          submittingOverlay.classList.remove('hidden');
          submittingOverlay.classList.add('flex');
        } else {
          submittingOverlay.classList.add('hidden');
          submittingOverlay.classList.remove('flex');
        }
      };

      const getMenuLabel = (category, id) => {
        if (!id) return '';
        const choices = MENU_OPTIONS[category] || [];
        const match = choices.find((option) => option.id === id);
        return match ? match.label : id;
      };

      const extractSubmittedAt = (rsvps) => {
        if (!rsvps) return '';
        for (const key of Object.keys(rsvps)) {
          const entry = rsvps[key];
          if (entry && entry.submittedAt) {
            return entry.submittedAt;
          }
        }
        return '';
      };

      const formatSubmittedAt = (value) => {
        if (!value) return '';
        try {
          const date = new Date(value);
          if (!Number.isNaN(date.getTime())) {
            return date.toLocaleString(undefined, {
              dateStyle: 'long',
              timeStyle: 'short',
            });
          }
        } catch {
          // fall back to original string
        }
        return value;
      };

      const params = new URLSearchParams(window.location.search);
      const initialCode = (params.get('code') || '').trim();
      if (initialCode) {
        state.code = initialCode;
        state.status = 'loading';
      }

      const escapeHtml = (value) =>
        value.replace(/[&<>"']/g, (char) => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
        })[char]);

      const encodeBase64 = (value) => {
        const encoder = new TextEncoder();
        const bytes = encoder.encode(value);
        let binary = '';
        bytes.forEach((byte) => {
          binary += String.fromCharCode(byte);
        });
        return btoa(binary);
      };

      const slugify = (value, index) =>
        `${value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '')}-${index}`;

      const createPersonState = (name) => ({
        name,
        attendingDrinks: false,
        attendingDinner: false,
        unable: false,
        menu: { starter: '', main: '', dessert: '' },
        plusOneName: '',
      });

      const resetSubmitState = () => {
        state.submitStatus = 'idle';
        state.submitMessage = '';
        state.formError = '';
      };

      const updateUrlWithCode = (code) => {
        const url = new URL(window.location.href);
        if (code) {
          url.searchParams.set('code', code);
        } else {
          url.searchParams.delete('code');
        }
        window.history.replaceState({}, '', url.toString());
      };

      const setView = (view) => {
        container.setAttribute('data-view', view);
      };

      const render = () => {
        const {
          code,
          status,
          loadError,
          names,
          people,
        submitStatus,
        submitMessage,
        formError,
        summary,
      } = state;
        toggleSubmittingOverlay(submitStatus === 'submitting');

        if (!code) {
          setView('idle');
          container.innerHTML = `
            <form id="code-form" class="space-y-8">
              <header class="space-y-3 text-center">
                <h2 class="font-serif text-2xl text-lagoon">Enter your RSVP code</h2>
                <p class="text-sm text-lagoon/70">Your email invitation includes a short code. Please paste it in here to RSVP.</p>
              </header>
              ${loadError ? `<p class="rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">${escapeHtml(loadError)}</p>` : ''}
              <div class="space-y-2">
                <label for="code-input" class="block text-sm font-medium text-lagoon/80">RSVP code</label>
                <input id="code-input" name="code" type="text" required autocomplete="off" class="w-full rounded-2xl border border-teal/30 bg-white/90 px-4 py-3 text-base text-lagoon shadow-sm focus:border-teal focus:outline-none focus:ring-2 focus:ring-teal/40" placeholder="e.g. my-rsvp-code" />
              </div>
              <button type="submit" class="inline-flex w-full items-center justify-center rounded-full bg-teal px-6 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-white transition hover:bg-teal/90 focus:outline-none focus:ring-2 focus:ring-teal/40">Find my invitation</button>
            </form>
          `;

          const form = container.querySelector('#code-form');
          if (form) {
            form.addEventListener('submit', (event) => {
              event.preventDefault();
              const formData = new FormData(form);
              const value = (formData.get('code') || '').toString().trim();
              if (!value) return;
              state.code = value;
              resetSubmitState();
              updateUrlWithCode(value);
              fetchPeople();
            });
          }
          return;
        }

        if (status === 'loading') {
          setView('loading');
          container.innerHTML = `
            <div class="space-y-6 text-center">
              <div class="flex justify-center">
                <span class="inline-flex h-14 w-14 items-center justify-center rounded-full border-4 border-teal/30 border-t-teal/80">
                  <span class="h-7 w-7 animate-ping rounded-full bg-teal/60"></span>
                </span>
              </div>
              <div>
                <p class="font-serif text-2xl text-lagoon">Checking your invitation‚Ä¶</p>
                <p class="mt-2 text-sm text-lagoon/70">We‚Äôre fetching the names linked to <span class="font-medium">${escapeHtml(code)}</span>.</p>
              </div>
            </div>
          `;
          return;
        }

        if (status === 'error') {
          setView('error');
          container.innerHTML = `
            <div class="space-y-6 text-center">
              <div class="space-y-3">
                <h2 class="font-serif text-2xl text-lagoon">We couldn't find that code</h2>
                <p class="text-sm text-lagoon/70">${escapeHtml(
                    (loadError === 'Authorization code not recognized' || !loadError) ? 'Double-check the spelling on your invitation and try again.' : loadError)}</p>
              </div>
              <div class="flex flex-col gap-3 sm:flex-row sm:justify-center">
                <button type="button" data-action="retry" class="inline-flex items-center justify-center rounded-full bg-teal px-6 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-white transition hover:bg-teal/90 focus:outline-none focus:ring-2 focus:ring-teal/40">Try another code</button>
              </div>
            </div>
          `;

          const retry = container.querySelector('[data-action="retry"]');
          if (retry) {
            retry.addEventListener('click', () => {
              state.code = '';
              state.status = 'idle';
              state.loadError = '';
              state.names = [];
              state.people = {};
              resetSubmitState();
              updateUrlWithCode('');
              render();
            });
          }
          return;
        }

        if (status === 'summary' && summary) {
          setView('summary');
          const submittedAtRaw =
            summary.submittedAt || extractSubmittedAt(summary.rsvps);
          const submittedAtLabel = formatSubmittedAt(submittedAtRaw);

          let summaryTitle = 'RSVP already submitted';
          let summaryBody =
            'We already have this RSVP on file. If anything changes, please reach out.';
          if (summary.notice === 'success') {
            summaryTitle = 'RSVP received ‚Äî thank you!';
            summaryBody =
              'We saved your responses below. If anything changes, please let us know.';
          } else if (summary.notice === 'locked' && summary.message) {
            summaryBody = summary.message;
          } else if (summary.notice === 'existing' && summary.message) {
            summaryBody = summary.message;
          }

          const summaryContactSuffix =
            summary.notice === 'success'
              ? `Messed something up? ${HOST_CONTACT_HTML}`
              : `${HOST_CONTACT_HTML}`;

          const summaryCards = names
            .map((name, index) => {
              const record = summary.rsvps ? summary.rsvps[name] : undefined;
              const slug = slugify(name, index);
              if (!record) {
                return `
                  <article class="space-y-4 rounded-[1.75rem] border border-teal/30 bg-white/80 p-6 shadow-sm">
                    <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                      <h3 class="font-serif text-xl text-lagoon">${escapeHtml(name)}</h3>
                      <span class="text-xs uppercase tracking-[0.3em] text-teal/70">Guest</span>
                    </header>
                    <p class="text-sm text-lagoon/70">We don‚Äôt have RSVP details for this guest yet.</p>
                  </article>
                `;
              }

              const drinksLine = record.attendingDrinks
                ? 'Joining for the cocktail hour'
                : 'Skipping the cocktail hour';

              const dinnerLine = record.attendingDinner
                ? 'Sharing dinner with us'
                : 'Not staying for dinner';

              const menuBlock =
                record.attendingDinner && record.menu
                  ? `
                      <div class="rounded-2xl border border-teal/20 bg-mist/60 px-4 py-3 text-sm text-lagoon/80">
                        <p class="text-xs uppercase tracking-[0.3em] text-teal/70">Dinner selections</p>
                        <ul class="mt-2 space-y-1">
                          <li><span class="font-semibold text-teal">Starter</span>: ${getMenuLabel('starter', record.menu.starter)}</li>
                          <li><span class="font-semibold text-teal">Main</span>: ${getMenuLabel('main', record.menu.main)}</li>
                          <li><span class="font-semibold text-teal">Dessert</span>: ${getMenuLabel('dessert', record.menu.dessert)}</li>
                        </ul>
                      </div>
                    `
                  : '';

              const notesBlock = record.notes
                ? `
                    <div class="rounded-2xl border border-dashed border-teal/30 bg-white/70 px-4 py-3 text-sm text-lagoon/80">
                      <p class="text-xs uppercase tracking-[0.3em] text-teal/70">Notes</p>
                      <p class="mt-1">${escapeHtml(record.notes)}</p>
                    </div>
                  `
                : '';

              return `
                <article class="space-y-5 rounded-[1.75rem] border border-teal/40 bg-white/85 p-6 shadow-sm" id="${slug}-summary">
                  <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                    <h3 class="font-serif text-xl text-lagoon">${escapeHtml(name)}</h3>
                    <span class="text-xs uppercase tracking-[0.3em] text-teal/70">${record.attendingDinner || record.attendingDrinks ? 'Celebrating with you' : 'Can\'t make it'}</span>
                  </header>
                  <ul class="space-y-3 text-sm text-lagoon/80">
                    <li class="flex items-center gap-3">
                      <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-mist/80 text-sm text-teal">üç∏</span>
                      <span>${escapeHtml(drinksLine)}</span>
                    </li>
                    <li class="flex items-center gap-3">
                      <span class="inline-flex h-8 w-8 items-center justify-center rounded-full bg-mist/80 text-sm text-teal">üçΩÔ∏è</span>
                      <span>${escapeHtml(dinnerLine)}</span>
                    </li>
                  </ul>
                  ${menuBlock}
                  ${notesBlock}
                </article>
              `;
            })
            .join('');

          container.innerHTML = `
            <section class="space-y-8">
              <header class="space-y-4 rounded-[1.75rem] border border-teal/30 bg-mist/60 p-6 text-center sm:text-left">
                <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                  <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-teal/70">RSVP Code</p>
                    <p class="font-serif text-2xl text-lagoon">${escapeHtml(code)}</p>
                  </div>
                  <button type="button" data-action="change-code" class="inline-flex items-center justify-center rounded-full border border-teal/40 bg-white/90 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-teal transition hover:border-teal/60 hover:bg-mist focus:outline-none focus:ring-2 focus:ring-teal/40">Event Information</button>
                </div>
                <div class="space-y-2">
                  <h2 class="font-serif text-2xl text-lagoon">${escapeHtml(summaryTitle)}</h2>
                  <p class="text-sm text-lagoon/70">${escapeHtml(summaryBody)}</p>
                  <p class="text-sm text-lagoon/70">${summaryContactSuffix}</p>
                  ${
                    submittedAtLabel
                      ? `<p class="text-xs uppercase tracking-[0.3em] text-teal/60">Submitted ${escapeHtml(submittedAtLabel)}</p>`
                      : ''
                  }
                </div>
              </header>
              <div class="space-y-6">
                ${summaryCards}
              </div>
            </section>
          `;

          const changeCodeButton = container.querySelector(
            '[data-action="change-code"]',
          );
          if (changeCodeButton) {
            changeCodeButton.addEventListener('click', () => {
                window.location.href = 'https://davidandsuzygotmarried.com/vancouver'
            });
          }
          return;
        }

        if (status === 'ready') {
          setView('form');
          const personSections = names
            .map((name, index) => {
              const person = people[name];
              if (!person) return '';
              const slug = slugify(name, index);
              const drinksId = `${slug}-drinks`;
              const dinnerId = `${slug}-dinner`;
              const unableId = `${slug}-unable`;
              const plusOne = name.includes('+1');

              const renderMenuGroup = (category, title, options) => {
                const selected = person.menu[category];
                const radios = options
                  .map((option) => {
                    const radioId = `${slug}-${category}-${option.id}`;
                    const isActive = selected === option.id;
                    return `
                      <label for="${radioId}" class="flex cursor-pointer items-start gap-3 rounded-2xl border ${isActive ? 'border-teal bg-mist/90' : 'border-teal/30 bg-white/80'} p-3 text-sm text-lagoon transition hover:border-teal/60">
                        <input type="radio" id="${radioId}" name="${slug}-${category}" value="${option.id}" ${isActive ? 'checked' : ''} data-name="${escapeHtml(name)}" data-field="menu-${category}" class="mt-1 h-4 w-4 border-teal text-teal focus:ring-teal" />
                        <span>${option.label}</span>
                      </label>
                    `;
                  })
                  .join('');

                return `
                  <fieldset class="space-y-3">
                    <legend class="text-sm font-semibold uppercase tracking-[0.2em] text-teal/70">${title}</legend>
                    <div class="space-y-3">${radios}</div>
                  </fieldset>
                `;
              };

              const vegetarianPairSelected =
                person.menu.starter === 'greens' || person.menu.main === 'vegetarian';
              const vegetarianMessage = vegetarianPairSelected
                ? `<p class="rounded-xl border border-teal/30 bg-white/80 px-4 py-3 text-xs text-lagoon/80">If you want the vegetarian option, you'll need to order both the vegetarian starter and main. I know, it's dumb, but the option is really only supposed to be for vegetarians.</p>`
                : '';

              const menuSection = person.attendingDinner
                ? `
                    <div class="mt-6 space-y-6 rounded-2xl border border-teal/20 bg-mist/50 p-5">
                      <p class="text-sm font-medium text-lagoon/80">Choose a course for ${escapeHtml(name.replace('+1', '').trim() || name)}.</p>
                      ${vegetarianMessage}
                      <div class="grid gap-6 md:grid-cols-3">
                        ${renderMenuGroup('starter', 'Starter', MENU_OPTIONS.starter)}
                        ${renderMenuGroup('main', 'Main', MENU_OPTIONS.main)}
                        ${renderMenuGroup('dessert', 'Dessert', MENU_OPTIONS.dessert)}
                      </div>
                    </div>
                  `
                : `
                    <div class="mt-6 rounded-2xl border border-dashed border-teal/30 bg-white/60 p-5 text-sm text-lagoon/60">
                      Select dinner above to see menu choices.
                    </div>
                  `;

              return `
                <article class="space-y-6 rounded-[1.75rem] border border-teal/40 bg-white/85 p-6 shadow-sm">
                  <header class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                    <h3 class="font-serif text-xl text-lagoon">${escapeHtml(name)}</h3>
                    <p class="text-xs uppercase tracking-[0.3em] text-teal/70">Dinner party guest</p>
                  </header>

                  ${plusOne ? `
                    <div class="space-y-2">
                      <label for="${slug}-plusone" class="block text-sm font-medium text-lagoon/80">Plus-one name</label>
                      <input id="${slug}-plusone" type="text" value="${escapeHtml(person.plusOneName)}" data-name="${escapeHtml(name)}" data-field="plus-one" placeholder="Tell us their name so we can place their card" class="w-full rounded-2xl border border-teal/30 bg-white/90 px-4 py-3 text-base text-lagoon shadow-sm focus:border-teal focus:outline-none focus:ring-2 focus:ring-teal/40" />
                    </div>
                  ` : ''}

                  <div class="space-y-4">
                    <div class="grid gap-3 sm:grid-cols-2">
                      <label for="${drinksId}" class="flex cursor-pointer items-center gap-3 rounded-2xl border ${person.attendingDrinks ? 'border-teal bg-mist/90' : 'border-teal/30 bg-white/80'} p-3 text-sm text-lagoon transition hover:border-teal/60">
                        <input type="checkbox" id="${drinksId}" ${person.attendingDrinks ? 'checked' : ''} ${person.unable ? 'disabled' : ''} data-name="${escapeHtml(name)}" data-field="drinks" class="h-4 w-4 rounded border-teal text-teal focus:ring-teal" />
                        <span>I'll join for cocktails &amp; champagne</span>
                      </label>

                      <label for="${dinnerId}" class="flex cursor-pointer items-center gap-3 rounded-2xl border ${person.attendingDinner ? 'border-teal bg-mist/90' : 'border-teal/30 bg-white/80'} p-3 text-sm text-lagoon transition hover:border-teal/60">
                        <input type="checkbox" id="${dinnerId}" ${person.attendingDinner ? 'checked' : ''} ${person.unable ? 'disabled' : ''} data-name="${escapeHtml(name)}" data-field="dinner" class="h-4 w-4 rounded border-teal text-teal focus:ring-teal" />
                        <span>I'll stay for the seated dinner</span>
                      </label>
                    </div>

                    <div class="rounded-2xl border border-dashed ${person.unable ? 'border-teal bg-cloud/80' : 'border-teal/30 bg-white/80'} p-4">
                      <label for="${unableId}" class="flex cursor-pointer items-center gap-3 text-sm text-lagoon">
                        <input type="checkbox" id="${unableId}" ${person.unable ? 'checked' : ''} data-name="${escapeHtml(name)}" data-field="unable" class="h-4 w-4 rounded border-teal text-teal focus:ring-teal" />
                        <span class="font-medium">Sadly, I can't make it</span>
                      </label>
                    </div>
                  </div>

                  ${menuSection}
                </article>
              `;
            })
            .join('');

          const failureNotice =
            submitStatus === 'failure'
              ? `
                  <div class="space-y-2 rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
                    <p>${escapeHtml(
                      submitMessage ||
                        'We ran into a problem saving your RSVP. Please try again.',
                    )}</p>
                    <p class="text-xs text-red-700/80">${HOST_CONTACT_HTML}</p>
                  </div>
                `
              : '';

          container.innerHTML = `
            <form id="rsvp-form" class="space-y-8">
              <header class="space-y-3 rounded-[1.75rem] border border-teal/30 bg-mist/60 p-6">
                <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                  <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-teal/70">RSVP Code</p>
                    <p class="font-serif text-2xl text-lagoon">${escapeHtml(code)}</p>
                  </div>
                  <button type="button" data-action="change-code" class="inline-flex items-center justify-center rounded-full border border-teal/40 bg-white/90 px-4 py-2 text-xs font-semibold uppercase tracking-[0.3em] text-teal transition hover:border-teal/60 hover:bg-mist focus:outline-none focus:ring-2 focus:ring-teal/40">Change code</button>
                </div>
              </header>

              ${formError ? `<p class="rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">${escapeHtml(formError)}</p>` : ''}
              ${submitStatus === 'success' ? `<p class="rounded-2xl border border-teal/40 bg-mist/70 px-4 py-3 text-sm text-teal/90">${escapeHtml(submitMessage || 'RSVP submitted! We‚Äôll see you soon.')}</p>` : ''}
              ${failureNotice}

              <div class="space-y-6">
                ${personSections}
              </div>

              <div class="flex flex-col gap-3 sm:flex-row sm:justify-end">
                <button id="submit" type="submit" ${submitStatus === 'submitting' ? 'disabled' : ''} class="inline-flex items-center justify-center rounded-full bg-teal px-6 py-3 text-sm font-semibold uppercase tracking-[0.3em] text-white transition hover:bg-teal/90 focus:outline-none focus:ring-2 focus:ring-teal/40 disabled:cursor-not-allowed disabled:opacity-70">
                  ${submitStatus === 'submitting' ? 'Sending RSVP‚Ä¶' : 'Submit RSVP'}
                </button>
              </div>
            </form>
          `;

          const form = container.querySelector('#rsvp-form');
          if (form) {
            const changeCodeButton = form.querySelector('[data-action="change-code"]');
            if (changeCodeButton) {
              changeCodeButton.addEventListener('click', () => {
                state.code = '';
                state.status = 'idle';
                state.names = [];
                state.people = {};
                state.loadError = '';
                resetSubmitState();
                updateUrlWithCode('');
                render();
              });
            }

            form.addEventListener('change', (event) => {
              const target = event.target;
              if (!(target instanceof HTMLInputElement)) return;
              const name = target.dataset.name;
              const field = target.dataset.field;
              if (!name || !field) return;
              const person = state.people[name];
              if (!person) return;

              if (field === 'drinks') {
                person.attendingDrinks = target.checked;
                if (target.checked) {
                  person.unable = false;
                }
              } else if (field === 'dinner') {
                person.attendingDinner = target.checked;
                if (target.checked) {
                  person.unable = false;
                } else {
                  person.menu = { starter: '', main: '', dessert: '' };
                }
              } else if (field === 'unable') {
                person.unable = target.checked;
                if (person.unable) {
                  person.attendingDrinks = false;
                  person.attendingDinner = false;
                  person.menu = { starter: '', main: '', dessert: '' };
                }
              } else if (field.startsWith('menu-')) {
                const category = field.split('-')[1];
                if (person.attendingDinner) {
                  const updatedMenu = { ...person.menu, [category]: target.value };

                  if (category === 'starter') {
                    if (target.value === 'greens') {
                      updatedMenu.main = 'vegetarian';
                    } else if (updatedMenu.main === 'vegetarian') {
                      updatedMenu.main = '';
                    }
                  } else if (category === 'main') {
                    if (target.value === 'vegetarian') {
                      updatedMenu.starter = 'greens';
                    } else if (updatedMenu.starter === 'greens') {
                      updatedMenu.starter = '';
                    }
                  }

                  person.menu = updatedMenu;
                }
              }

              resetSubmitState();
              window.requestAnimationFrame(() => {
                  render();
                })
            });

            form.addEventListener('input', (event) => {
              const target = event.target;
              if (!(target instanceof HTMLInputElement)) return;
              const name = target.dataset.name;
              if (!name) return;
              if (target.dataset.field === 'plus-one') {
                const person = state.people[name];
                if (person) {
                  person.plusOneName = target.value;
                }
              }
            });

            form.addEventListener('submit', async (event) => {
              event.preventDefault();
              if (!API_BASE_URL) {
                state.formError = 'Missing API base URL. Ask your host to set the `data-api-base` attribute on this page.';
                render();
                return;
              }

              const payload = [];
              for (const name of names) {
                const person = state.people[name];
                if (!person) continue;

                if (!person.unable && !person.attendingDrinks && !person.attendingDinner) {
                  state.formError = `Choose attendance for ${name}.`;
                  render();
                  return;
                }

                if (person.attendingDinner) {
                  const requiredMenu = ['starter', 'main', 'dessert'];
                  for (const category of requiredMenu) {
                    if (!person.menu[category]) {
                      state.formError = `Select a ${category} for ${name}.`;
                      render();
                      return;
                    }
                  }
                }

                if ((person.attendingDrinks || person.attendingDinner) && name.includes('+1') && !person.plusOneName.trim()) {
                  state.formError = `Tell us the name of the guest for ${name}.`;
                  render();
                  return;
                }

                const entry = {
                  name,
                  attendingDrinks: !person.unable && person.attendingDrinks,
                  attendingDinner: !person.unable && person.attendingDinner,
                };

                if (!person.unable && person.attendingDinner) {
                  entry.menu = {
                    starter: person.menu.starter,
                    main: person.menu.main,
                    dessert: person.menu.dessert,
                  };
                }

                if (name.includes('+1') && person.plusOneName.trim()) {
                  entry.notes = `Plus-one name: ${person.plusOneName.trim()}`;
                }

                payload.push(entry);
              }

              if (!payload.length) {
                state.formError = 'Add at least one guest to continue.';
                render();
                return;
              }

              state.formError = '';
              state.submitStatus = 'submitting';
              state.submitMessage = '';
              render();

              try {
                const response = await fetch(`${API_BASE_URL}/submit-rsvp`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${encodeBase64(state.code)}`,
                  },
                  body: JSON.stringify({ people: payload }),
                });

                const data = await response.json().catch(() => ({}));
                if (!response.ok) {
                  if (response.status === 409) {
                    const rsvps =
                      data && typeof data.rsvps === 'object' && data.rsvps !== null
                        ? data.rsvps
                        : {};

                    state.summary = {
                      rsvps,
                      submittedAt:
                        (data && data.submittedAt) ||
                        extractSubmittedAt(rsvps),
                      notice: 'locked',
                      message:
                        (data && data.message) ||
                        'We already have this RSVP on file for your code.',
                    };
                    state.status = 'summary';
                    state.submitStatus = 'idle';
                    state.submitMessage = '';
                    state.formError = '';
                    render();
                    return;
                  }

                  const message =
                    data && data.message
                      ? data.message
                      : 'Unable to submit your RSVP right now.';
                  state.submitStatus = 'failure';
                  state.submitMessage = message;
                  render();
                  return;
                }

                const fallbackTimestamp = new Date().toISOString();
                const rsvps =
                  data && typeof data.rsvps === 'object' && data.rsvps !== null
                    ? data.rsvps
                    : payload.reduce((acc, entry) => {
                        acc[entry.name] = {
                          attendingDrinks: entry.attendingDrinks,
                          attendingDinner: entry.attendingDinner,
                          menu: entry.menu
                            ? {
                                starter: entry.menu.starter,
                                main: entry.menu.main,
                                dessert: entry.menu.dessert,
                              }
                            : undefined,
                          notes: entry.notes,
                          submittedAt: fallbackTimestamp,
                        };
                        return acc;
                      }, {});

                const submittedAt =
                  (data && data.submittedAt) || extractSubmittedAt(rsvps);

                state.summary = {
                  rsvps,
                  submittedAt,
                  notice: 'success',
                  message:
                    (data && data.message) ||
                    'RSVP submitted successfully. We will confirm shortly.',
                };
                state.status = 'summary';
                state.submitStatus = 'success';
                state.submitMessage =
                  (data && data.message) ||
                  'RSVP submitted successfully. We will confirm shortly.';
                render();
              } catch (error) {
                console.error('Error submitting RSVP', error);
                state.submitStatus = 'failure';
                state.submitMessage = 'We lost the connection while saving. Please try again.';
                render();
              }
            });
          }
          return;
        }

        container.innerHTML = `
          <div class="space-y-3 text-center">
            <p class="font-serif text-2xl text-lagoon">Almost ready‚Ä¶</p>
            <p class="text-sm text-lagoon/70">If you stay on this screen, refresh the page to restart.</p>
          </div>
        `;
      };

      const fetchPeople = async () => {
        if (!state.code) {
          state.status = 'idle';
          render();
          return;
        }

        state.status = 'loading';
        state.loadError = '';
        resetSubmitState();
        render();

        if (!API_BASE_URL) {
          state.status = 'error';
          state.loadError = 'Missing API base URL. Ask your host to set the `data-api-base` attribute on this page.';
          render();
          return;
        }

        try {
          const response = await fetch(`${API_BASE_URL}/people`, {
            headers: {
              Authorization: `Bearer ${encodeBase64(state.code)}`,
            },
          });

          if (!response.ok) {
            let message = 'That code was not recognized. Check the invitation and try again.';
            try {
              const data = await response.json();
              if (data && data.message) {
                message = data.message;
              }
            } catch {
              // ignore
            }
            state.status = 'error';
            state.loadError = message;
            render();
            return;
          }

          const data = await response.json();
          const names = Array.isArray(data.names) ? data.names : [];
          if (!names.length) {
            state.status = 'error';
            state.loadError = 'No guests are attached to that code. Reach out to the hosts for help.';
            render();
            return;
          }

          state.names = names;
          state.people = names.reduce((acc, personName) => {
            acc[personName] = createPersonState(personName);
            return acc;
          }, {});
          const rsvps =
            data && typeof data.rsvps === 'object' && data.rsvps !== null
              ? data.rsvps
              : {};

          if (Object.keys(rsvps).length > 0) {
            state.summary = {
              rsvps,
              submittedAt:
                (data && data.submittedAt) || extractSubmittedAt(rsvps),
              notice: 'existing',
              message:
                (data && data.message) ||
                'We already have an RSVP for this code. Here‚Äôs what we saved.',
            };
            state.status = 'summary';
            state.submitStatus = 'idle';
            state.submitMessage = '';
            state.formError = '';
            render();
            return;
          }

          state.summary = null;
          state.status = 'ready';
          render();
        } catch (error) {
          console.error('Error fetching people', error);
          state.status = 'error';
          state.loadError = 'We were unable to connect to the RSVP service. Please try again in a moment.';
          render();
        }
      };

      render();

      if (initialCode) {
        fetchPeople();
      } else {
        state.status = 'idle';
        render();
      }
    })();
  </script>
</body>
</html>
